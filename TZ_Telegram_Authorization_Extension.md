# Техническое задание: Расширение авторизации через Telegram

## Проект: Ninja Goods

### Цель
Реализовать расширение существующей системы авторизации для поддержки Telegram Login.  
Система должна позволять пользователям авторизоваться через Telegram и работать в рамках текущей архитектуры проекта, добавляя новые роли и связи между пользователями без изменения базовых принципов авторизации.

---

## 1. Общие положения
Авторизация через Telegram реализуется как дополнительный способ входа в существующую систему.  
Пользователь может войти с помощью Telegram Login Widget, после чего система:
- Проверяет подлинность данных Telegram (через hash-подпись)
- Создает или обновляет профиль пользователя в базе
- Выдает JWT-токен для внутренней авторизации

---

## 2. Роли пользователей

### 2.1 Закупщик
Основная роль. Создает организацию и размещает заказы.  
Может:
- Регистрировать организацию
- Добавлять сотрудников
- Создавать и размещать заказы
- Просматривать историю заказов

### 2.2 Сотрудник организации
Привязан к закупщику.  
Может:
- Просматривать активные заказы
- Добавлять позиции в заказ
- Изменять количество своих позиций

---

## 3. Поток авторизации и регистрации

### 3.1 Telegram Login
Используется Telegram Login Widget (Telegram Authorization).  
Возвращаемые данные:
`id`, `first_name`, `last_name`, `username`, `photo_url`, `auth_date`, `hash`  
Подпись проверяется сервером (HMAC-SHA256). После успешной проверки создается JWT.

### 3.2 Новый пользователь
Если пользователя с данным Telegram ID нет, ему предлагается выбор:
- Я закупщик
- Я сотрудник

---

## 4. Регистрация закупщика

### Поля формы
- Название ресторана  
- Название юридического лица (ООО / ИП)  
- ИНН  
- КПП (опционально)  
- ОГРН / ОГРНИП  
- Юридический адрес  
- Фактический адрес поставки  
- Контактный телефон  
- Email  
- Комментарий  
- Telegram username (автозаполняется)

После заполнения создается запись в таблице `organizations` и Telegram ID закупщика связывается с ней.

---

## 5. Регистрация сотрудника

### Приглашение от закупщика
Сотрудник не регистрируется самостоятельно. Закупщик генерирует ссылку-приглашение:
```
https://app.domain.com/join?org={organization_id}&token={invite_token}
```
После перехода сотрудник авторизуется через Telegram, и система:
- Проверяет токен
- Привязывает сотрудника к организации
- Назначает роль `employee`
- Показывает текущие заказы

---

## 6. Логика заказов

1. Закупщик создает заказ (черновик)  
2. Сотрудники добавляют позиции  
3. Закупщик утверждает заказ  
4. Заказ отправляется в админ-панель

---

## 7. Админ-панель

В админке отображаются:
- Название организации  
- Контакт закупщика  
- Состав заказа  
- Статус и дата размещения  

---

## 8. Структура данных

### users
| Поле | Тип | Описание |
|------|------|----------|
| id | bigint | ID |
| telegram_id | bigint | Telegram user ID |
| username | varchar | Username |
| first_name | varchar | Имя |
| last_name | varchar | Фамилия |
| role | enum('buyer','employee') | Роль |
| organization_id | bigint | ID организации |
| created_at | datetime | Создан |
| updated_at | datetime | Обновлен |

### organizations
| Поле | Тип | Описание |
|------|------|----------|
| id | bigint | ID |
| name | varchar | Название ресторана |
| legal_name | varchar | Юрлицо |
| inn | varchar | ИНН |
| kpp | varchar | КПП |
| ogrn | varchar | ОГРН |
| address_legal | varchar | Юридический адрес |
| address_actual | varchar | Адрес поставки |
| phone | varchar | Телефон |
| email | varchar | Email |
| comment | text | Примечание |
| created_by | bigint | Закупщик |
| created_at | datetime | Создан |

### orders
| Поле | Тип | Описание |
|------|------|----------|
| id | bigint | ID |
| organization_id | bigint | Организация |
| buyer_id | bigint | Закупщик |
| status | enum('draft','pending','submitted') | Статус |
| created_at | datetime | Создан |
| submitted_at | datetime | Размещен |

### order_items
| Поле | Тип | Описание |
|------|------|----------|
| id | bigint | ID |
| order_id | bigint | Заказ |
| employee_id | bigint | Сотрудник |
| product_name | varchar | Наименование |
| quantity | decimal | Количество |
| comment | text | Комментарий |

---

## 9. Безопасность
- Проверка hash от Telegram  
- Взаимодействие по HTTPS  
- JWT для сессий (lifetime 7 дней)  
- Доступ к API только с валидным токеном  

---

## 10. API (черновой список)
`POST /auth/telegram` — авторизация через Telegram  
`POST /organizations` — регистрация организации  
`POST /invites` — генерация приглашения  
`POST /join` — регистрация сотрудника  
`GET /orders` — список заказов  
`POST /orders` — создание заказа  
`POST /orders/{id}/submit` — размещение заказа  
`POST /orders/{id}/items` — добавление позиций  

---

## 11. UI-потоки

**Закупщик:**
1. Авторизация через Telegram  
2. Регистрация организации  
3. Создание заказа  
4. Приглашение сотрудников  
5. Размещение заказа  

**Сотрудник:**
1. Переход по приглашению  
2. Авторизация через Telegram  
3. Привязка к организации  
4. Добавление позиций в заказ  

---

## 12. Технические детали

- Расширение интегрируется в существующую систему авторизации   
- Telegram Login Widget  
- БД: PostgreSQL  
- JWT для внутренних сессий  
